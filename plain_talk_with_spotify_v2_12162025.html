<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Black SAM ‚Ä¢ Radio Justice (Memphis) ‚Äî REAL</title>

<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  :root {
    --bg:#0b0d12; --panel:#121522; --panel2:#161a2a;
    --text:#e9e9ef; --muted:#a6abbc;
    --gold:#ffd042; --purple:#8b5cf6; --mint:#4dff96; --red:#ff4d6d; --blue:#38b6ff;
    --border:#262b3d; --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  body { margin:0; background: radial-gradient(1200px 600px at 50% -10%, rgba(139,92,246,.25), transparent 55%),
                       radial-gradient(900px 500px at 10% 20%, rgba(255,208,66,.22), transparent 55%),
                       var(--bg);
         color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .ticker {
    position: sticky; top:0; z-index: 9999;
    background: rgba(0,0,0,.82); backdrop-filter: blur(10px);
    border-bottom: 2px solid rgba(255,208,66,.6);
    overflow:hidden; white-space:nowrap; padding:10px 0;
  }
  .ticker span {
    display:inline-block; padding-left:100%;
    animation: ticker 18s linear infinite;
    font-weight: 900; letter-spacing:.4px; color: var(--gold);
  }
  @keyframes ticker { 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
  .wrap { max-width: 1020px; margin: 0 auto; padding: 18px 14px 60px; }
  .hero {
    margin-top: 10px;
    background: linear-gradient(180deg, rgba(18,21,34,.92), rgba(18,21,34,.72));
    border:1px solid var(--border); border-radius: 18px; padding: 16px 16px 18px;
    box-shadow: var(--shadow);
  }
  .title {
    margin:0; text-align:center; font-weight: 1000;
    font-size: clamp(26px, 4vw, 40px);
    letter-spacing: .6px;
    color: var(--gold);
    text-shadow: 0 0 14px rgba(139,92,246,.45);
  }
  .sub {
    text-align:center; margin: 6px 0 0; color: var(--muted); font-weight: 650;
  }
  .badges { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top: 10px; }
  .badge {
    border:1px solid var(--border); background: rgba(22,26,42,.72);
    padding: 6px 10px; border-radius: 999px; color: var(--muted);
    font-size: 12px; font-weight: 750;
  }
  .grid { display:grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
  @media (min-width: 920px) { .grid { grid-template-columns: 1fr 1fr; } }
  .card {
    background: rgba(18,21,34,.92);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 14px 14px 16px;
    box-shadow: var(--shadow);
  }
  h2 { margin: 0 0 10px; font-size: 18px; letter-spacing:.3px; }
  h3 { margin: 10px 0 6px; font-size: 14px; color: var(--blue); }
  .muted { color: var(--muted); font-size: 13px; }
  label { display:block; margin: 8px 0 6px; font-weight: 800; color: #d9d9e8; }
  input, select {
    width: 100%;
    box-sizing: border-box;
    padding: 11px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(22,26,42,.86);
    color: var(--text);
    font-size: 15px;
    outline: none;
  }
  input::placeholder { color: rgba(166,171,188,.8); }
  .row { display:flex; gap: 10px; flex-wrap: wrap; }
  .row > * { flex: 1 1 140px; }
  button {
    width: 100%;
    padding: 12px 12px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 900;
    font-size: 15px;
    background: linear-gradient(90deg, var(--gold), var(--purple));
    color: #0b0d12;
  }
  button.secondary {
    background: rgba(22,26,42,.86);
    border: 1px solid var(--border);
    color: var(--text);
  }
  .kpi {
    display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;
  }
  .kpi .box {
    background: rgba(22,26,42,.86);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .kpi .v { font-size: 24px; font-weight: 1000; }
  .kpi .t { color: var(--muted); font-size: 12px; font-weight: 750; }
  .ok { color: var(--mint); }
  .warn { color: var(--gold); }
  .bad { color: var(--red); }
  #map {
    height: 340px;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  .list {
    background: rgba(22,26,42,.86);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px 12px;
    margin-top: 10px;
    font-size: 13px;
    color: var(--text);
  }
  .linkbtn {
    display:inline-block; margin: 6px 6px 0 0;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(22,26,42,.86);
    color: var(--text);
    font-weight: 850;
    text-decoration:none;
  }
  .tiny { font-size: 12px; color: rgba(166,171,188,.92); }
  .divider { height:1px; background: rgba(38,43,61,.9); margin: 10px 0; }
  iframe.spotify { width:100%; height: 80px; border:0; border-radius: 12px; }
</style>
</head>
<body>
  <div class="ticker">
    <span>üî¥ LIVE ‚Äî BLACK SAM RADIO JUSTICE ‚Ä¢ Memphis ‚Ä¢ truth + receipts ‚Ä¢ build BSAM-REAL-20251217T040638Z-5818D618 ‚Ä¢ no fluff ‚Ä¢ real data where we can ‚Ä¢</span>
  </div>

  <div class="wrap">
    <div class="hero">
      <h1 class="title">Black SAM ‚Ä¢ Radio Justice</h1>
      <p class="sub">Memphis-first dashboard: weather + air quality + data centers + ‚Äúfree help‚Äù map links + market + weed corner.</p>
      <div class="badges">
        <div class="badge">REAL AQI (Open‚ÄëMeteo)</div>
        <div class="badge">REAL Map Pins (OSM/Overpass)</div>
        <div class="badge">No logins required (except Spotify)</div>
        <div class="badge">Build ID: BSAM-REAL-20251217T040638Z-5818D618</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>üéß Music</h2>
      <div class="muted">Spotify embed plays in-browser (Spotify may require you to be logged in on that device).</div>
      <div style="margin-top:10px;">
        <iframe class="spotify"
          src="https://open.spotify.com/embed/playlist/37i9dQZF1DX4Wsb4d7NKfP"
          allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"></iframe>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üå¶Ô∏è Memphis Weather + üå´Ô∏è Air Quality</h2>
        <div class="muted">Type a ZIP/city or use device location. Weather + US AQI + ozone come from Open‚ÄëMeteo.</div>

        <label>City / ZIP (default: Memphis)</label>
        <input id="placeInput" placeholder="Memphis or 38103" value="Memphis 38103"/>

        <div class="row" style="margin-top:8px;">
          <button onclick="refreshAll()">Refresh</button>
          <button class="secondary" onclick="useMyLocation()">Use My Location</button>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="v" id="tempF">--</div>
            <div class="t">Temperature (¬∞F)</div>
          </div>
          <div class="box">
            <div class="v" id="wxDesc">--</div>
            <div class="t">Conditions</div>
          </div>
          <div class="box">
            <div class="v" id="aqiVal">--</div>
            <div class="t">US AQI</div>
          </div>
          <div class="box">
            <div class="v" id="ozoneVal">--</div>
            <div class="t">Ozone (¬µg/m¬≥)</div>
          </div>
        </div>

        <div class="tiny" id="geoNote" style="margin-top:10px;">Geocode: --</div>
      </div>

      <div class="card">
        <h2>üìö Library + ‚ÄúFree Help‚Äù Links</h2>
        <div class="muted">One tap opens maps searches near your area (food pantry, legal aid, job center, shelter, utility help).</div>

        <label>City / ZIP (used for map buttons)</label>
        <input id="helpPlace" placeholder="Memphis or 38103" value="Memphis 38103"/>

        <div class="divider"></div>
        <div>
          <a class="linkbtn" id="btnLibrary" target="_blank" rel="noopener">üìö Public Library</a>
          <a class="linkbtn" id="btnFood" target="_blank" rel="noopener">ü•´ Food Pantry</a>
          <a class="linkbtn" id="btnLegal" target="_blank" rel="noopener">‚öñÔ∏è Legal Aid</a>
          <a class="linkbtn" id="btnJobs" target="_blank" rel="noopener">üß∞ Job Center</a>
          <a class="linkbtn" id="btnShelter" target="_blank" rel="noopener">üè† Shelter</a>
          <a class="linkbtn" id="btnUtility" target="_blank" rel="noopener">üí° Utility Help</a>
        </div>

        <div class="list" style="margin-top:12px;">
          <b>Tip:</b> these buttons don‚Äôt ‚Äúeat your data‚Äù inside the app ‚Äî they open your normal map search in a new tab.
        </div>

        <div class="divider"></div>
        <h3>Quick Library Finder (OSM)</h3>
        <div class="muted">Shows nearby libraries on the map pins list (powered by OpenStreetMap data).</div>
        <button class="secondary" onclick="findLibraries()">Find Libraries Near Current Coords</button>
        <div class="list" id="libList">No results yet.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üè≠ Data Centers Map (Real Pins)</h2>
        <div class="muted">This map pulls ‚Äúdata centre‚Äù features from OpenStreetMap near your current coordinates (Overpass API).</div>

        <div id="map"></div>
        <div class="kpi" style="margin-top:10px;">
          <div class="box">
            <div class="v" id="dcCount">--</div>
            <div class="t">Data centers found</div>
          </div>
          <div class="box">
            <div class="v" id="radiusMi">31</div>
            <div class="t">Search radius (miles)</div>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="radiusInput" type="number" min="5" max="200" value="31" />
          <button onclick="refreshDataCenters()">Refresh Pins</button>
        </div>

        <div class="list" id="dcList">No results yet.</div>
      </div>

      <div class="card">
        <h2>üåç ‚ÄúRunning Ticket‚Äù ‚Äî Carbon + Money (Based on Inputs)</h2>
        <div class="muted">This is not fake randomness: the ticker is computed from your inputs (MW load, PUE, grid intensity, price).</div>

        <div class="row">
          <div>
            <label>IT Load (MW)</label>
            <input id="mw" type="number" step="0.1" value="50"/>
          </div>
          <div>
            <label>PUE</label>
            <input id="pue" type="number" step="0.01" value="1.3"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Grid Intensity (gCO‚ÇÇ/kWh)</label>
            <input id="intensity" type="number" step="1" value="400"/>
          </div>
          <div>
            <label>Electricity Price ($/MWh)</label>
            <input id="price" type="number" step="1" value="60"/>
          </div>
        </div>

        <div class="row">
          <button onclick="startTicker()">Start</button>
          <button class="secondary" onclick="stopTicker()">Stop</button>
          <button class="secondary" onclick="resetTicker()">Reset</button>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="v" id="co2Live">0</div>
            <div class="t">CO‚ÇÇ (kg) since start</div>
          </div>
          <div class="box">
            <div class="v" id="moneyLive">$0</div>
            <div class="t">$ electricity since start</div>
          </div>
        </div>

        <div class="tiny" style="margin-top:10px;">
          Formula: MW √ó PUE ‚Üí facility MW; kWh/sec √ó intensity ‚Üí g/sec ‚Üí kg; kWh √ó $/MWh ‚Üí $.
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üçÅ Weed Corner</h2>
        <div class="muted">Strain picker + dispensary map search (new tab).</div>
        <div class="row">
          <button onclick="randomStrain()">Random Strain</button>
          <button class="secondary" onclick="openDisp()">Find Dispensaries Near Me</button>
        </div>
        <div class="list" id="strainBox">Press ‚ÄúRandom Strain.‚Äù</div>
      </div>

      <div class="card">
        <h2>üí∞ Market Watch</h2>
        <div class="muted">Live chart embed (TradingView). Default is JPM. Type a ticker and hit refresh.</div>
        <div class="row">
          <input id="ticker" placeholder="JPM" value="JPM" />
          <button onclick="loadChart()">Show Chart</button>
        </div>
        <div id="chartBox" style="margin-top:12px;"></div>
        <div class="tiny">If a ticker is on a different exchange, you can try ‚ÄúNASDAQ:AAPL‚Äù etc in the box.</div>
      </div>
    </div>

    <div class="card">
      <h2>‚ö° Get Hype</h2>
      <div class="muted">Fast morale boost when the world is loud.</div>
      <div class="row">
        <button onclick="randomQuote()">New Quote</button>
        <button class="secondary" onclick="copyQuote()">Copy</button>
      </div>
      <div class="list" id="quoteBox">Press ‚ÄúNew Quote.‚Äù</div>
    </div>

    <div class="card">
      <h2>üßæ Receipts</h2>
      <div class="muted">Build ID + data sources used in this file.</div>
      <div class="list">
        <div><b>Build:</b> BSAM-REAL-20251217T040638Z-5818D618</div>
        <div><b>Weather + AQI + Ozone:</b> Open‚ÄëMeteo APIs</div>
        <div><b>Data center pins + libraries:</b> OpenStreetMap via Overpass API + Leaflet map</div>
        <div><b>Market chart:</b> TradingView embed</div>
        <div><b>Maps buttons:</b> your browser opens a search query in a new tab</div>
      </div>
    </div>

  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
/* ------------------ utils ------------------ */
let STATE = {
  lat: 35.1495,
  lon: -90.0490,
  placeLabel: "Memphis, TN",
};
function fmt(n) {
  if (n === null || n === undefined || Number.isNaN(n)) return "--";
  return String(n);
}
function mapsSearchLink(q) {
  return "https://www.google.com/maps/search/" + encodeURIComponent(q);
}
function setHelpLinks() {
  const p = (document.getElementById("helpPlace").value || "Memphis 38103").trim();
  document.getElementById("btnLibrary").href = mapsSearchLink("public library " + p);
  document.getElementById("btnFood").href    = mapsSearchLink("food pantry " + p);
  document.getElementById("btnLegal").href   = mapsSearchLink("legal aid " + p);
  document.getElementById("btnJobs").href    = mapsSearchLink("job center " + p);
  document.getElementById("btnShelter").href = mapsSearchLink("homeless shelter " + p);
  document.getElementById("btnUtility").href = mapsSearchLink("utility assistance " + p);
}
document.getElementById("helpPlace").addEventListener("input", setHelpLinks);
setHelpLinks();

/* ------------------ geocode ------------------ */
async function geocodePlace(q) {
  // Open-Meteo geocoding (no key)
  const url = "https://geocoding-api.open-meteo.com/v1/search?count=1&language=en&format=json&name=" + encodeURIComponent(q);
  const r = await fetch(url);
  const j = await r.json();
  if (!j || !j.results || !j.results.length) throw new Error("No geocode results");
  const g = j.results[0];
  return {
    lat: g.latitude,
    lon: g.longitude,
    label: [g.name, g.admin1, g.country].filter(Boolean).join(", ")
  };
}
async function useMyLocation() {
  if (!navigator.geolocation) return alert("Geolocation not available on this device.");
  navigator.geolocation.getCurrentPosition(async (pos) => {
    STATE.lat = pos.coords.latitude;
    STATE.lon = pos.coords.longitude;
    STATE.placeLabel = "Your location";
    document.getElementById("geoNote").textContent = "Geocode: device location (" + STATE.lat.toFixed(4) + ", " + STATE.lon.toFixed(4) + ")";
    await refreshAll(true);
  }, () => alert("Location permission denied."));
}
async function refreshAll(skipGeocode=false) {
  try {
    let q = (document.getElementById("placeInput").value || "Memphis 38103").trim();
    if (!skipGeocode) {
      const g = await geocodePlace(q);
      STATE.lat = g.lat; STATE.lon = g.lon; STATE.placeLabel = g.label;
      document.getElementById("geoNote").textContent = "Geocode: " + g.label + " (" + STATE.lat.toFixed(4) + ", " + STATE.lon.toFixed(4) + ")";
      document.getElementById("helpPlace").value = q;
      setHelpLinks();
    }
    await Promise.all([loadWeather(), loadAQI(), refreshDataCenters()]);
  } catch (e) {
    console.log(e);
    alert("Could not refresh: " + e.message);
  }
}
/* ------------------ weather ------------------ */
async function loadWeather() {
  const url = "https://api.open-meteo.com/v1/forecast?latitude=" + STATE.lat +
              "&longitude=" + STATE.lon + "&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=auto";
  const r = await fetch(url);
  const j = await r.json();
  const temp = j?.current?.temperature_2m;
  const code = j?.current?.weather_code;
  document.getElementById("tempF").textContent = (temp!==undefined) ? Math.round(temp) + "¬∞F" : "--";
  document.getElementById("wxDesc").textContent = weatherCodeToText(code);
}
function weatherCodeToText(code) {
  const m = {
    0:"Clear", 1:"Mostly clear", 2:"Partly cloudy", 3:"Overcast",
    45:"Fog", 48:"Rime fog",
    51:"Light drizzle", 53:"Drizzle", 55:"Heavy drizzle",
    61:"Light rain", 63:"Rain", 65:"Heavy rain",
    71:"Light snow", 73:"Snow", 75:"Heavy snow",
    80:"Light showers", 81:"Showers", 82:"Heavy showers",
    95:"Thunderstorm"
  };
  if (code===undefined || code===null) return "--";
  return m[code] || ("Code " + code);
}
/* ------------------ AQI + ozone ------------------ */
async function loadAQI() {
  // Open-Meteo Air Quality (no key). Pull latest hourly.
  const url = "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=" + STATE.lat +
              "&longitude=" + STATE.lon + "&hourly=us_aqi,ozone&timezone=auto";
  const r = await fetch(url);
  const j = await r.json();
  const aqiArr = j?.hourly?.us_aqi || [];
  const ozArr  = j?.hourly?.ozone || [];
  const idx = aqiArr.length ? (aqiArr.length - 1) : -1;
  const aqi = idx>=0 ? aqiArr[idx] : null;
  const oz  = idx>=0 ? ozArr[idx] : null;
  const aqiEl = document.getElementById("aqiVal");
  aqiEl.textContent = (aqi!==null && aqi!==undefined) ? String(aqi) : "--";
  aqiEl.className = "v " + aqiClass(aqi);
  const ozEl = document.getElementById("ozoneVal");
  ozEl.textContent = (oz!==null && oz!==undefined) ? String(Math.round(oz)) : "--";
  ozEl.className = "v " + aqiClass(aqi);
}
function aqiClass(aqi) {
  if (aqi===null || aqi===undefined || Number.isNaN(aqi)) return "";
  if (aqi <= 50) return "ok";
  if (aqi <= 100) return "warn";
  return "bad";
}

/* ------------------ Leaflet map ------------------ */
let map = L.map('map', { zoomControl: true }).setView([STATE.lat, STATE.lon], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let dcLayer = L.layerGroup().addTo(map);

/* ------------------ Overpass query (data centers) ------------------ */
async function refreshDataCenters() {
  const mi = parseFloat(document.getElementById("radiusInput").value || "31");
  document.getElementById("radiusMi").textContent = String(mi);
  const meters = Math.max(5000, Math.min(320000, mi * 1609.34));
  map.setView([STATE.lat, STATE.lon], mi <= 15 ? 11 : (mi <= 40 ? 10 : 9));

  const q = `[out:json][timeout:25];
  (
    node["man_made"="data_centre"](around:${meters},${STATE.lat},${STATE.lon});
    way["man_made"="data_centre"](around:${meters},${STATE.lat},${STATE.lon});
    node["power"="data_centre"](around:${meters},${STATE.lat},${STATE.lon});
    way["power"="data_centre"](around:${meters},${STATE.lat},${STATE.lon});
  );
  out center;`;
  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q);
  const r = await fetch(url);
  const j = await r.json();
  const els = j?.elements || [];
  dcLayer.clearLayers();

  const items = [];
  for (const el of els) {
    const lat = el.lat ?? el.center?.lat;
    const lon = el.lon ?? el.center?.lon;
    if (lat===undefined || lon===undefined) continue;
    const name = el.tags?.name || el.tags?.operator || "Data centre";
    const addr = [el.tags?.["addr:housenumber"], el.tags?.["addr:street"], el.tags?.["addr:city"]].filter(Boolean).join(" ");
    items.push({ name, addr, lat, lon });
  }

  // de-dup close duplicates
  const uniq = [];
  for (const it of items) {
    const exists = uniq.some(u => Math.abs(u.lat-it.lat)<0.0007 && Math.abs(u.lon-it.lon)<0.0007);
    if (!exists) uniq.push(it);
  }

  for (const it of uniq) {
    const m = L.marker([it.lat, it.lon]).addTo(dcLayer);
    const link = mapsSearchLink(it.name + " near " + STATE.placeLabel);
    m.bindPopup(`<b>${escapeHtml(it.name)}</b><br>${escapeHtml(it.addr || STATE.placeLabel)}<br><a target="_blank" rel="noopener" href="${link}">Open in Maps</a>`);
  }

  document.getElementById("dcCount").textContent = String(uniq.length);
  const list = uniq.slice(0, 10).map((it, i) => `‚Ä¢ ${escapeHtml(it.name)} ‚Äî ${escapeHtml(it.addr || STATE.placeLabel)}`).join("<br>");
  document.getElementById("dcList").innerHTML = uniq.length ? (`<b>Top matches (up to 10):</b><br>${list}`) : "No OSM-tagged data centers found in this radius. Try expanding the radius.";
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}

/* ------------------ libraries via Overpass ------------------ */
async function findLibraries() {
  const meters = 25000; // ~15 miles
  const q = `[out:json][timeout:25];
  (
    node["amenity"="library"](around:${meters},${STATE.lat},${STATE.lon});
    way["amenity"="library"](around:${meters},${STATE.lat},${STATE.lon});
  );
  out center;`;
  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q);
  const r = await fetch(url);
  const j = await r.json();
  const els = j?.elements || [];
  const libs = [];
  for (const el of els) {
    const lat = el.lat ?? el.center?.lat;
    const lon = el.lon ?? el.center?.lon;
    if (lat===undefined || lon===undefined) continue;
    const name = el.tags?.name || "Library";
    libs.push({name, lat, lon});
  }
  const uniq = [];
  for (const it of libs) {
    const exists = uniq.some(u => Math.abs(u.lat-it.lat)<0.0007 && Math.abs(u.lon-it.lon)<0.0007);
    if (!exists) uniq.push(it);
  }
  const lines = uniq.slice(0, 12).map((it) => {
    const link = mapsSearchLink(it.name + " " + STATE.placeLabel);
    return `‚Ä¢ <a target="_blank" rel="noopener" style="color:var(--mint)" href="${link}">${escapeHtml(it.name)}</a>`;
  }).join("<br>");
  document.getElementById("libList").innerHTML = uniq.length ? lines : "No libraries found near current coords (OSM).";
}

/* ------------------ running ticket (computed) ------------------ */
let tickerTimer = null;
let co2kg = 0;
let money = 0;
function computeRates() {
  const mw = parseFloat(document.getElementById("mw").value || "0");
  const pue = parseFloat(document.getElementById("pue").value || "1");
  const intensity = parseFloat(document.getElementById("intensity").value || "0"); // g/kWh
  const price = parseFloat(document.getElementById("price").value || "0"); // $/MWh

  const facilityMW = Math.max(0, mw) * Math.max(0.8, pue);
  const kWhPerSec = facilityMW * 1000 / 3600;
  const gPerSec = kWhPerSec * intensity;
  const kgPerSec = gPerSec / 1000.0;
  const dollarsPerSec = kWhPerSec * (price / 1000.0); // $/kWh
  return { kgPerSec, dollarsPerSec };
}
function startTicker() {
  if (tickerTimer) return;
  const rates = computeRates();
  tickerTimer = setInterval(() => {
    const r = computeRates();
    co2kg += r.kgPerSec;
    money += r.dollarsPerSec;
    document.getElementById("co2Live").textContent = Math.round(co2kg).toLocaleString();
    document.getElementById("moneyLive").textContent = "$" + Math.round(money).toLocaleString();
  }, 1000);
}
function stopTicker() {
  if (!tickerTimer) return;
  clearInterval(tickerTimer);
  tickerTimer = null;
}
function resetTicker() {
  stopTicker();
  co2kg = 0; money = 0;
  document.getElementById("co2Live").textContent = "0";
  document.getElementById("moneyLive").textContent = "$0";
}

/* ------------------ weed corner ------------------ */
const strains=[
  "Blue Dream","Gelato","OG Kush","Girl Scout Cookies","Pineapple Express",
  "Sour Diesel","Granddaddy Purple","Wedding Cake","Zkittlez","Purple Haze"
];
function randomStrain() {
  const s = strains[Math.floor(Math.random()*strains.length)];
  document.getElementById("strainBox").textContent = s;
}
function openDisp() {
  const q = (document.getElementById("helpPlace").value || "Memphis 38103").trim();
  window.open(mapsSearchLink("dispensary " + q), "_blank", "noopener");
}

/* ------------------ market chart ------------------ */
function loadChart() {
  const raw = (document.getElementById("ticker").value.trim() || "JPM").toUpperCase();
  // Accept "NASDAQ:AAPL" else default NYSE symbol
  const symbol = raw.includes(":") ? raw : (raw + ":NYSE");
  const url = "https://s.tradingview.com/widgetembed/?symbol=" + encodeURIComponent(symbol) +
              "&interval=D&symboledit=1&saveimage=1&toolbarbg=f1f3f6&theme=dark&locale=en";
  document.getElementById("chartBox").innerHTML =
    `<iframe style="width:100%;height:380px;border-radius:14px;border:1px solid var(--border)" src="${url}" allowfullscreen></iframe>`;
}

/* ------------------ hype ------------------ */
const quotes=[
  "You don‚Äôt need permission to build.",
  "Receipts beat vibes. Every time.",
  "Move fast, but keep your people safe.",
  "If it‚Äôs not measurable, it‚Äôs a story ‚Äî measure it.",
  "Protect the block. Protect the future.",
  "Turn frustration into structure.",
  "No one gets left behind on the math."
];
function randomQuote() {
  const q = quotes[Math.floor(Math.random()*quotes.length)];
  document.getElementById("quoteBox").textContent = q;
}
async function copyQuote() {
  const t = document.getElementById("quoteBox").textContent || "";
  try {
    await navigator.clipboard.writeText(t);
  } catch (e) {
    // ignore
  }
}

/* ------------------ init ------------------ */
(async function init() {
  loadChart();
  randomQuote();
  document.getElementById("geoNote").textContent = "Geocode: Memphis, TN (default) (" + STATE.lat.toFixed(4) + ", " + STATE.lon.toFixed(4) + ")";
  await refreshAll(true);
})();
</script>
</body>
</html>
